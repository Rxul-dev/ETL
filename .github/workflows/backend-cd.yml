name: Backend CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.HETZNER_HOST }}" ]; then
            echo "‚ö†Ô∏è HETZNER_HOST secret is not configured. Skipping deployment."
            echo "To enable deployment, configure the following secrets in GitHub:"
            echo "  - HETZNER_HOST"
            echo "  - HETZNER_USER"
            echo "  - HETZNER_SSH_KEY"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Hetzner
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_SSH_KEY_PASSPHRASE || '' }}
          script: |
            set -e
            
            # Crear directorio si no existe
            DEPLOY_DIR="/opt/rxul-chat-backend"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "üìÅ Creando directorio $DEPLOY_DIR..."
              sudo mkdir -p $DEPLOY_DIR
              sudo chown $USER:$USER $DEPLOY_DIR
            fi
            
            cd $DEPLOY_DIR
            
            # Clonar repositorio solo si no existe
            if [ ! -d ".git" ]; then
              echo "üì• Clonando repositorio (primera vez)..."
              git clone https://github.com/${{ github.repository }}.git $DEPLOY_DIR
              cd $DEPLOY_DIR
            else
              echo "üîÑ Actualizando repositorio (pull suave)..."
              # Solo hacer pull, sin reset ni clean para no perder cambios locales
              git fetch origin
              git pull origin main || {
                echo "‚ö†Ô∏è Pull fall√≥, intentando merge..."
                git merge origin/main || echo "‚ö†Ô∏è Merge fall√≥, pero continuando..."
              }
            fi
            
            # Verificar docker-compose (puede ser 'docker compose' o 'docker-compose')
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            elif docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            else
              echo "‚ùå Error: docker-compose no est√° instalado"
              exit 1
            fi
            
            echo "üê≥ Usando: $DOCKER_COMPOSE"
            
            # Crear archivo .env solo si no existe (nunca sobreescribir)
            # NOTA: Las contrase√±as deben estar en el archivo .env del servidor, no en el c√≥digo
            if [ ! -f ".env" ]; then
              echo "üìù Creando archivo .env (primera vez)..."
              echo "‚ö†Ô∏è ADVERTENCIA: Debes configurar las contrase√±as manualmente en .env"
              echo "# Base de datos principal" > .env
              echo "DB_PASSWORD=CHANGE_ME" >> .env
              echo "DATABASE_URL=postgresql+psycopg2://postgres:CHANGE_ME@db:5432/messaging" >> .env
              echo "" >> .env
              echo "# Data Warehouse (opcional)" >> .env
              echo "DW_PASSWORD=CHANGE_ME" >> .env
              echo "WAREHOUSE_URL=postgresql://postgres:CHANGE_ME@dw:5432/warehouse" >> .env
              echo "" >> .env
              echo "# Metabase" >> .env
              echo "METABASE_DB_PASSWORD=CHANGE_ME" >> .env
              echo "" >> .env
              echo "# Temporal" >> .env
              echo "TEMPORAL_TARGET=temporal:7233" >> .env
              echo "TEMPORAL_NAMESPACE=default" >> .env
              echo "" >> .env
              echo "# API Base URL" >> .env
              echo "API_BASE_URL=http://api:8000" >> .env
              echo "" >> .env
              echo "# Grafana Admin Password (opcional)" >> .env
              echo "GRAFANA_ADMIN_PASSWORD=ChangeMe123!" >> .env
              echo "" >> .env
              echo "# CORS (opcional)" >> .env
              echo "# CORS_ORIGINS=http://91.98.64.119,http://localhost:5173" >> .env
              echo "‚úÖ Archivo .env creado con valores por defecto"
              echo "‚ö†Ô∏è IMPORTANTE: Actualiza las contrase√±as (CHANGE_ME) antes de iniciar los servicios"
              echo "   Variables requeridas: DB_PASSWORD, DW_PASSWORD, METABASE_DB_PASSWORD"
            else
              echo "‚ÑπÔ∏è Archivo .env ya existe - respetando configuraci√≥n existente"
              echo "‚ö†Ô∏è Verifica que el .env tenga las variables: DB_PASSWORD, DW_PASSWORD, METABASE_DB_PASSWORD"
            fi
            
            # Deploy conservador - solo reconstruir y actualizar si es necesario
            echo "üîÑ Verificando estado de contenedores..."
            
            # Construir im√°genes nuevas
            echo "üî® Construyendo im√°genes..."
            $DOCKER_COMPOSE build
            
            # Actualizar contenedores solo si hay cambios
            # up -d es idempotente: no detiene contenedores que ya est√°n corriendo
            # solo los actualiza si la imagen o configuraci√≥n cambi√≥
            echo "üöÄ Actualizando contenedores (solo si hay cambios)..."
            $DOCKER_COMPOSE up -d
            
            # Mostrar estado
            echo "üìä Estado de contenedores:"
            $DOCKER_COMPOSE ps
            
            echo "üìã √öltimos logs:"
            $DOCKER_COMPOSE logs --tail=50

