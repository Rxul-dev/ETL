name: Backend CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.HETZNER_HOST }}" ]; then
            echo "âš ï¸ HETZNER_HOST secret is not configured. Skipping deployment."
            echo "To enable deployment, configure the following secrets in GitHub:"
            echo "  - HETZNER_HOST"
            echo "  - HETZNER_USER"
            echo "  - HETZNER_SSH_KEY"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Deploy to Hetzner
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_SSH_KEY_PASSPHRASE }}
          script: |
            set -e
            
            # Crear directorio si no existe
            DEPLOY_DIR="/opt/rxul-chat-backend"
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "ğŸ“ Creando directorio $DEPLOY_DIR..."
              sudo mkdir -p $DEPLOY_DIR
              sudo chown $USER:$USER $DEPLOY_DIR
            fi
            
            cd $DEPLOY_DIR
            
            # Clonar repositorio si no existe
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Clonando repositorio..."
              # Si el directorio tiene archivos pero no es git, limpiarlo
              if [ "$(ls -A $DEPLOY_DIR 2>/dev/null)" ]; then
                echo "âš ï¸ Directorio no vacÃ­o pero no es git. Limpiando..."
                cd /tmp
                sudo rm -rf $DEPLOY_DIR
                sudo mkdir -p $DEPLOY_DIR
                sudo chown $USER:$USER $DEPLOY_DIR
              fi
              git clone https://github.com/${{ github.repository }}.git $DEPLOY_DIR
              cd $DEPLOY_DIR
            else
              echo "ğŸ”„ Actualizando repositorio..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            fi
            
            # Verificar docker-compose (puede ser 'docker compose' o 'docker-compose')
            if command -v docker-compose &> /dev/null; then
              DOCKER_COMPOSE="docker-compose"
            elif docker compose version &> /dev/null; then
              DOCKER_COMPOSE="docker compose"
            else
              echo "âŒ Error: docker-compose no estÃ¡ instalado"
              exit 1
            fi
            
            echo "ğŸ³ Usando: $DOCKER_COMPOSE"
            
            # Crear archivo .env si no existe
            if [ ! -f ".env" ]; then
              echo "ğŸ“ Creando archivo .env..."
              echo "# Base de datos principal" > .env
              echo "DATABASE_URL=postgresql+psycopg2://postgres:postgres@db:5432/messaging" >> .env
              echo "" >> .env
              echo "# Data Warehouse (opcional)" >> .env
              echo "WAREHOUSE_URL=postgresql://postgres:postgres@dw:5432/warehouse" >> .env
              echo "" >> .env
              echo "# Temporal" >> .env
              echo "TEMPORAL_TARGET=temporal:7233" >> .env
              echo "TEMPORAL_NAMESPACE=default" >> .env
              echo "" >> .env
              echo "# API Base URL" >> .env
              echo "API_BASE_URL=http://api:8000" >> .env
              echo "âœ… Archivo .env creado"
            else
              echo "â„¹ï¸ Archivo .env ya existe"
            fi
            
            # Deploy
            echo " Deteniendo contenedores..."
            $DOCKER_COMPOSE down || true
            
            echo "ğŸ”¨ Construyendo imÃ¡genes..."
            $DOCKER_COMPOSE build
            
            echo "ğŸš€ Iniciando contenedores..."
            $DOCKER_COMPOSE up -d
            
            echo "ğŸ“‹ Ãšltimos logs:"
            $DOCKER_COMPOSE logs --tail=50

