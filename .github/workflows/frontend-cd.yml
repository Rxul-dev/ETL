name: Frontend CD

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'nginx/**'
      - '.github/workflows/frontend-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.HETZNER_HOST }}" ]; then
            echo "âš ï¸ HETZNER_HOST secret is not configured. Skipping deployment."
            echo "To enable deployment, configure the following secrets in GitHub:"
            echo "  - HETZNER_HOST"
            echo "  - HETZNER_USER"
            echo "  - HETZNER_SSH_KEY"
            echo "  - VITE_API_URL (optional, for frontend build)"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      
      - name: Build
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
          VITE_AMPLITUDE_API_KEY: ${{ secrets.VITE_AMPLITUDE_API_KEY }}
        run: |
          # Solo exportar VITE_API_URL si estÃ¡ definido y no estÃ¡ vacÃ­o
          # Si no estÃ¡ definido, el cÃ³digo usarÃ¡ la IP pÃºblica de la VM por defecto
          if [ -n "$VITE_API_URL" ]; then
            echo "Building with VITE_API_URL=$VITE_API_URL"
          else
            echo "Building without VITE_API_URL - will use default VM IP (91.98.64.119:8000)"
          fi
          if [ -n "$VITE_AMPLITUDE_API_KEY" ]; then
            echo "Building with VITE_AMPLITUDE_API_KEY configured"
          else
            echo "âš ï¸ VITE_AMPLITUDE_API_KEY not configured - Analytics will not work"
          fi
          npm run build
      
      - name: Clean old build files on VM
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            set -e
            echo "ðŸ§¹ Limpiando archivos de build antiguos..."
            DEPLOY_DIR="/opt/rxul-chat-frontend/dist"
            # Crear directorio padre si no existe
            sudo mkdir -p /opt/rxul-chat-frontend
            if [ -d "$DEPLOY_DIR" ]; then
              sudo rm -rf "$DEPLOY_DIR"/*
              sudo rm -rf "$DEPLOY_DIR"/.* 2>/dev/null || true
              echo "âœ… Directorio limpiado"
            else
              sudo mkdir -p "$DEPLOY_DIR"
              echo "âœ… Directorio creado"
            fi
            # Asegurar permisos del directorio padre
            sudo chown -R $USER:$USER /opt/rxul-chat-frontend || true
            sudo chmod 755 /opt/rxul-chat-frontend || true
      
      - name: Deploy to Hetzner
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          source: "frontend/dist/*" # Copiar todos los archivos de dist
          target: "/tmp/frontend-deploy"
      
      - name: Move files to correct location
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            set -e
            echo "ðŸ“¦ Moviendo archivos a la ubicaciÃ³n correcta..."
            DEPLOY_DIR="/opt/rxul-chat-frontend/dist"
            TEMP_DIR="/tmp/frontend-deploy"
            
            # Si los archivos estÃ¡n en una subcarpeta frontend, moverlos
            if [ -d "$TEMP_DIR/frontend/dist" ]; then
              echo "   Archivos en $TEMP_DIR/frontend/dist, moviendo..."
              sudo mv "$TEMP_DIR/frontend/dist"/* "$DEPLOY_DIR/" 2>/dev/null || true
              sudo mv "$TEMP_DIR/frontend/dist"/.* "$DEPLOY_DIR/" 2>/dev/null || true
            elif [ -d "$TEMP_DIR/frontend" ]; then
              echo "   Archivos en $TEMP_DIR/frontend, moviendo..."
              sudo mv "$TEMP_DIR/frontend"/* "$DEPLOY_DIR/" 2>/dev/null || true
              sudo mv "$TEMP_DIR/frontend"/.* "$DEPLOY_DIR/" 2>/dev/null || true
            elif [ -d "$TEMP_DIR/dist" ]; then
              echo "   Archivos en $TEMP_DIR/dist, moviendo..."
              sudo mv "$TEMP_DIR/dist"/* "$DEPLOY_DIR/" 2>/dev/null || true
              sudo mv "$TEMP_DIR/dist"/.* "$DEPLOY_DIR/" 2>/dev/null || true
            else
              echo "   Archivos directamente en $TEMP_DIR, moviendo..."
              sudo mv "$TEMP_DIR"/* "$DEPLOY_DIR/" 2>/dev/null || true
              sudo mv "$TEMP_DIR"/.* "$DEPLOY_DIR/" 2>/dev/null || true
            fi
            
            # Limpiar directorio temporal
            sudo rm -rf "$TEMP_DIR"
            echo "âœ… Archivos movidos correctamente"
      
      - name: Set permissions and verify deployment
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            set -e
            echo "ðŸ”§ Configurando permisos..."
            DEPLOY_DIR="/opt/rxul-chat-frontend/dist"
            
            # Asegurar que el directorio existe
            if [ ! -d "$DEPLOY_DIR" ]; then
              echo "âŒ Error: Directorio $DEPLOY_DIR no existe"
              exit 1
            fi
            
            # Establecer permisos correctos
            # www-data necesita leer los archivos, pero el usuario actual los copiÃ³
            sudo chown -R www-data:www-data "$DEPLOY_DIR"
            sudo chmod -R 755 "$DEPLOY_DIR"
            sudo find "$DEPLOY_DIR" -type f -exec chmod 644 {} \;
            sudo find "$DEPLOY_DIR" -type d -exec chmod 755 {} \;
            
            echo "âœ… Permisos configurados"
            
            # Verificar que los archivos existen
            echo "ðŸ“‹ Verificando archivos desplegados..."
            if [ -f "$DEPLOY_DIR/index.html" ]; then
              echo "âœ… index.html existe"
              ls -la "$DEPLOY_DIR" | head -10
            else
              echo "âŒ Error: index.html no existe en $DEPLOY_DIR"
              echo "Contenido del directorio:"
              ls -la "$DEPLOY_DIR" || echo "Directorio vacÃ­o o no accesible"
              exit 1
            fi
            
            # Verificar que Nginx puede leer los archivos
            echo "ðŸ” Verificando acceso de Nginx..."
            if sudo -u www-data test -r "$DEPLOY_DIR/index.html"; then
              echo "âœ… Nginx puede leer index.html"
            else
              echo "âš ï¸ Advertencia: Nginx puede no poder leer los archivos"
            fi
      
      - name: Copy nginx configuration
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          source: "nginx/rxul-chat-frontend.conf"
          target: "/tmp/rxul-chat-frontend.conf"
      
      - name: Configure and restart nginx
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            set -e
            
            # Instalar nginx si no estÃ¡ instalado
            if ! command -v nginx &> /dev/null; then
              echo "ðŸ“¦ Instalando nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # Crear directorio para configuraciÃ³n si no existe
            sudo mkdir -p /etc/nginx/sites-available
            sudo mkdir -p /etc/nginx/sites-enabled
            
            # Deshabilitar configuraciÃ³n por defecto de Nginx si existe
            sudo rm -f /etc/nginx/sites-enabled/default
            
            # Copiar configuraciÃ³n de nginx
            NGINX_SOURCE="/tmp/rxul-chat-frontend.conf"
            NGINX_TARGET="/etc/nginx/sites-available/rxul-chat-frontend"
            
            if [ -f "$NGINX_SOURCE" ]; then
              echo "ðŸ“ Copiando configuraciÃ³n de nginx..."
              sudo cp "$NGINX_SOURCE" "$NGINX_TARGET"
              sudo rm "$NGINX_SOURCE"  # Limpiar archivo temporal
            else
              echo "âš ï¸ Archivo de configuraciÃ³n no encontrado, creando uno bÃ¡sico..."
              sudo tee "$NGINX_TARGET" > /dev/null << 'NGINXEOF'
            server {
                listen 80;
                server_name _;
                root /opt/rxul-chat-frontend/dist;
                index index.html;
                location / {
                    try_files $uri $uri/ /index.html;
                }
                location /api/ {
                    proxy_pass http://127.0.0.1:8000/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
                location /ws/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINXEOF
            fi
            
            # Activar configuraciÃ³n
            echo "ðŸ”— Activando configuraciÃ³n de nginx..."
            sudo ln -sf "$NGINX_TARGET" /etc/nginx/sites-enabled/rxul-chat-frontend
            
            # Verificar configuraciÃ³n
            echo "âœ… Verificando configuraciÃ³n de nginx..."
            sudo nginx -t
            
            # Asegurar permisos del directorio
            sudo chown -R www-data:www-data /opt/rxul-chat-frontend/dist || true
            
            # Abrir puerto 80 en firewall si ufw estÃ¡ activo
            if command -v ufw &> /dev/null; then
              echo "ðŸ”¥ Configurando firewall..."
              sudo ufw allow 80/tcp || true
            fi
            
            # Reiniciar nginx
            echo "ðŸ”„ Reiniciando nginx..."
            sudo systemctl restart nginx || sudo systemctl start nginx
            
            # Habilitar nginx para que inicie automÃ¡ticamente
            sudo systemctl enable nginx || true
            
            echo "âœ… Nginx configurado y reiniciado correctamente"

