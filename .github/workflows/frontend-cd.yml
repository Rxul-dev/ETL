name: Frontend CD

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'nginx/**'
      - '.github/workflows/frontend-cd.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check deployment secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.HETZNER_HOST }}" ]; then
            echo "âš ï¸ HETZNER_HOST secret is not configured. Skipping deployment."
            echo "To enable deployment, configure the following secrets in GitHub:"
            echo "  - HETZNER_HOST"
            echo "  - HETZNER_USER"
            echo "  - HETZNER_SSH_KEY"
            echo "  - VITE_API_URL (optional, for frontend build)"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Node.js
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      
      - name: Build
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./frontend
        run: |
          # Solo exportar VITE_API_URL si estÃ¡ definido y no estÃ¡ vacÃ­o
          # Si no estÃ¡ definido o estÃ¡ vacÃ­o, el cÃ³digo usarÃ¡ /api automÃ¡ticamente
          if [ -n "${{ secrets.VITE_API_URL }}" ]; then
            export VITE_API_URL="${{ secrets.VITE_API_URL }}"
          fi
          npm run build
      
      - name: Deploy to Hetzner
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_SSH_KEY_PASSPHRASE }}
          source: "frontend/dist/*"
          target: "/opt/rxul-chat-frontend/dist"
      
      - name: Copy nginx configuration
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_SSH_KEY_PASSPHRASE }}
          source: "nginx/rxul-chat-frontend.conf"
          target: "/tmp/rxul-chat-frontend.conf"
      
      - name: Configure and restart nginx
        if: steps.check-secrets.outputs.skip != 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          passphrase: ${{ secrets.HETZNER_SSH_KEY_PASSPHRASE }}
          script: |
            set -e
            
            # Instalar nginx si no estÃ¡ instalado
            if ! command -v nginx &> /dev/null; then
              echo "ðŸ“¦ Instalando nginx..."
              sudo apt-get update
              sudo apt-get install -y nginx
            fi
            
            # Crear directorio para configuraciÃ³n si no existe
            sudo mkdir -p /etc/nginx/sites-available
            sudo mkdir -p /etc/nginx/sites-enabled
            
            # Deshabilitar configuraciÃ³n por defecto de Nginx si existe
            sudo rm -f /etc/nginx/sites-enabled/default
            
            # Copiar configuraciÃ³n de nginx
            NGINX_SOURCE="/tmp/rxul-chat-frontend.conf"
            NGINX_TARGET="/etc/nginx/sites-available/rxul-chat-frontend"
            
            if [ -f "$NGINX_SOURCE" ]; then
              echo "ðŸ“ Copiando configuraciÃ³n de nginx..."
              sudo cp "$NGINX_SOURCE" "$NGINX_TARGET"
              sudo rm "$NGINX_SOURCE"  # Limpiar archivo temporal
            else
              echo "âš ï¸ Archivo de configuraciÃ³n no encontrado, creando uno bÃ¡sico..."
              sudo tee "$NGINX_TARGET" > /dev/null << 'NGINXEOF'
            server {
                listen 80;
                server_name _;
                root /opt/rxul-chat-frontend/dist;
                index index.html;
                location / {
                    try_files $uri $uri/ /index.html;
                }
                location /api/ {
                    proxy_pass http://127.0.0.1:8000/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
                location /ws/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINXEOF
            fi
            
            # Activar configuraciÃ³n
            echo "ðŸ”— Activando configuraciÃ³n de nginx..."
            sudo ln -sf "$NGINX_TARGET" /etc/nginx/sites-enabled/rxul-chat-frontend
            
            # Verificar configuraciÃ³n
            echo "âœ… Verificando configuraciÃ³n de nginx..."
            sudo nginx -t
            
            # Asegurar permisos del directorio
            sudo chown -R www-data:www-data /opt/rxul-chat-frontend/dist || true
            
            # Abrir puerto 80 en firewall si ufw estÃ¡ activo
            if command -v ufw &> /dev/null; then
              echo "ðŸ”¥ Configurando firewall..."
              sudo ufw allow 80/tcp || true
            fi
            
            # Reiniciar nginx
            echo "ðŸ”„ Reiniciando nginx..."
            sudo systemctl restart nginx || sudo systemctl start nginx
            
            # Habilitar nginx para que inicie automÃ¡ticamente
            sudo systemctl enable nginx || true
            
            echo "âœ… Nginx configurado y reiniciado correctamente"

