name: Frontend CD - DigitalOcean

on:
  workflow_run:
    workflows: ["Terraform Apply"]
    types:
      - completed
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'nginx/**'
      - '.github/workflows/frontend-cd-digitalocean.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Droplet IPs
        uses: actions/download-artifact@v4
        with:
          name: droplet-ips
          path: .github
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
        continue-on-error: true
      
      - name: Check if DigitalOcean droplets exist
        id: check-droplets
        run: |
          if [ -f ".github/droplet-ips.json" ]; then
            # Intentar obtener IP de app (backend + frontend) o frontend (compatibilidad)
            FRONTEND_IP=$(jq -r '.app // .frontend' .github/droplet-ips.json)
            if [ "$FRONTEND_IP" != "null" ] && [ -n "$FRONTEND_IP" ]; then
              echo "âœ… DigitalOcean droplet encontrado (app-prod): $FRONTEND_IP"
              echo "frontend_ip=$FRONTEND_IP" >> $GITHUB_OUTPUT
              echo "use_digitalocean=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ No hay IP de app/frontend en DigitalOcean"
              echo "use_digitalocean=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Archivo de IPs no encontrado, usando Hetzner si estÃ¡ configurado"
            echo "use_digitalocean=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Set up Node.js
        if: steps.check-droplets.outputs.use_digitalocean == 'true' || secrets.HETZNER_HOST != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        if: steps.check-droplets.outputs.use_digitalocean == 'true' || secrets.HETZNER_HOST != ''
        working-directory: ./frontend
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      
      - name: Build
        if: steps.check-droplets.outputs.use_digitalocean == 'true' || secrets.HETZNER_HOST != ''
        working-directory: ./frontend
        run: |
          if [ -n "${{ secrets.VITE_API_URL }}" ]; then
            export VITE_API_URL="${{ secrets.VITE_API_URL }}"
            echo "Building with VITE_API_URL=$VITE_API_URL"
          else
            echo "Building without VITE_API_URL - will use default"
          fi
          npm run build
      
      - name: Deploy to DigitalOcean
        if: steps.check-droplets.outputs.use_digitalocean == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.check-droplets.outputs.frontend_ip }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/tmp/frontend-deploy"
      
      - name: Setup Frontend on DigitalOcean
        if: steps.check-droplets.outputs.use_digitalocean == 'true'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ steps.check-droplets.outputs.frontend_ip }}
          username: root
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -e
            echo "â³ Esperando a que el droplet estÃ© listo..."
            sleep 30
            
            DEPLOY_DIR="/opt/rxul-chat-frontend/dist"
            TEMP_DIR="/tmp/frontend-deploy"
            
            # Crear directorio
            mkdir -p "$DEPLOY_DIR"
            
            # Mover archivos
            if [ -d "$TEMP_DIR/dist" ]; then
              mv "$TEMP_DIR/dist"/* "$DEPLOY_DIR/" 2>/dev/null || true
            else
              mv "$TEMP_DIR"/* "$DEPLOY_DIR/" 2>/dev/null || true
            fi
            rm -rf "$TEMP_DIR"
            
            # Instalar Nginx si no estÃ¡ instalado
            if ! command -v nginx &> /dev/null; then
              echo "ðŸ“¦ Instalando nginx..."
              apt-get update
              apt-get install -y nginx
            fi
            
            # Configurar Nginx
            mkdir -p /etc/nginx/sites-available
            mkdir -p /etc/nginx/sites-enabled
            rm -f /etc/nginx/sites-enabled/default
            
            cat > /etc/nginx/sites-available/rxul-chat-frontend << 'NGINXEOF'
            server {
                listen 80;
                server_name _;
                root /opt/rxul-chat-frontend/dist;
                index index.html;
                location / {
                    try_files $uri $uri/ /index.html;
                }
                location /api/ {
                    proxy_pass http://127.0.0.1:8000/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
                location /ws/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINXEOF
            
            ln -sf /etc/nginx/sites-available/rxul-chat-frontend /etc/nginx/sites-enabled/
            nginx -t
            systemctl restart nginx
            systemctl enable nginx
            
            # Configurar firewall
            if command -v ufw &> /dev/null; then
              ufw allow 80/tcp || true
            fi
            
            echo "âœ… Frontend desplegado correctamente en DigitalOcean"
      
      - name: Deploy to Hetzner (Fallback)
        if: steps.check-droplets.outputs.use_digitalocean != 'true' && secrets.HETZNER_HOST != ''
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          source: "frontend/dist/*"
          target: "/tmp/frontend-deploy"
      
      - name: Setup Frontend on Hetzner
        if: steps.check-droplets.outputs.use_digitalocean != 'true' && secrets.HETZNER_HOST != ''
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HETZNER_HOST }}
          username: ${{ secrets.HETZNER_USER }}
          key: ${{ secrets.HETZNER_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="/opt/rxul-chat-frontend/dist"
            TEMP_DIR="/tmp/frontend-deploy"
            sudo mkdir -p "$DEPLOY_DIR"
            if [ -d "$TEMP_DIR/dist" ]; then
              sudo mv "$TEMP_DIR/dist"/* "$DEPLOY_DIR/" 2>/dev/null || true
            else
              sudo mv "$TEMP_DIR"/* "$DEPLOY_DIR/" 2>/dev/null || true
            fi
            sudo rm -rf "$TEMP_DIR"
            sudo chown -R www-data:www-data "$DEPLOY_DIR"
            sudo chmod -R 755 "$DEPLOY_DIR"
            if [ ! -f "/etc/nginx/sites-available/rxul-chat-frontend" ]; then
              sudo tee /etc/nginx/sites-available/rxul-chat-frontend > /dev/null << 'NGINXEOF'
            server {
                listen 80;
                server_name _;
                root /opt/rxul-chat-frontend/dist;
                index index.html;
                location / {
                    try_files $uri $uri/ /index.html;
                }
                location /api/ {
                    proxy_pass http://127.0.0.1:8000/;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
                location /ws/ {
                    proxy_pass http://127.0.0.1:8000;
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                }
            }
            NGINXEOF
              sudo ln -sf /etc/nginx/sites-available/rxul-chat-frontend /etc/nginx/sites-enabled/
            fi
            sudo nginx -t
            sudo systemctl restart nginx

