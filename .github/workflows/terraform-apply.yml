name: Terraform Apply

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-apply.yml'

jobs:
  terraform:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Terraform secrets
        id: check-secrets
        run: |
          # Usar DO_SSH_KEY_ID si existe, sino usar SSH_KEY_ID
          SSH_KEY_ID="${{ secrets.DO_SSH_KEY_ID || secrets.SSH_KEY_ID }}"
          
          if [ -z "${{ secrets.DO_TOKEN }}" ]; then
            echo "âš ï¸ DO_TOKEN secret is not configured. Skipping Terraform apply."
            echo "To enable Terraform, configure the following secrets in GitHub:"
            echo "  - DO_TOKEN (DigitalOcean API token)"
            echo "  - SSH_KEY_ID o DO_SSH_KEY_ID (SSH key ID in DigitalOcean)"
            echo "skip=true" >> $GITHUB_OUTPUT
          elif [ -z "$SSH_KEY_ID" ]; then
            echo "âš ï¸ SSH_KEY_ID o DO_SSH_KEY_ID secret is not configured or is empty. Skipping Terraform apply."
            echo "To enable Terraform, configure the following secrets in GitHub:"
            echo "  - DO_TOKEN (DigitalOcean API token)"
            echo "  - SSH_KEY_ID o DO_SSH_KEY_ID (SSH key ID in DigitalOcean - must be a number)"
            echo ""
            echo "ðŸ’¡ Para obtener el ID de tu SSH key:"
            echo "   1. Ve a https://cloud.digitalocean.com/account/security"
            echo "   2. Encuentra tu clave SSH"
            echo "   3. El ID es el nÃºmero que aparece en la lista"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Secrets configurados correctamente"
            echo "DO_TOKEN: configurado" 
            echo "SSH_KEY_ID: $SSH_KEY_ID"
            echo "ssh_key_id=$SSH_KEY_ID" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup Terraform
        if: steps.check-secrets.outputs.skip != 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        run: terraform init
      
      - name: Check existing droplets
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        run: |
          echo "ðŸ” Verificando droplets existentes..."
          terraform init -input=false || true
          
          # Intentar importar estado si existe
          if terraform state list 2>/dev/null | grep -q "digitalocean_droplet"; then
            echo "âœ… Hay droplets en el estado de Terraform"
            terraform state list | grep "digitalocean_droplet" || true
          else
            echo "â„¹ï¸ No hay droplets en el estado de Terraform (primera vez)"
          fi
      
      - name: Terraform Plan
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        continue-on-error: true
        run: |
          terraform apply -auto-approve tfplan || {
            EXIT_CODE=$?
            echo "âš ï¸ Terraform apply fallÃ³ con cÃ³digo: $EXIT_CODE"
            echo ""
            echo "ðŸ’¡ Posibles causas:"
            echo "  - LÃ­mite de droplets alcanzado en DigitalOcean"
            echo "  - CrÃ©dito insuficiente"
            echo "  - Error de API"
            echo ""
            echo "ðŸ“‹ Droplets que se crearon exitosamente:"
            terraform state list 2>/dev/null | grep "digitalocean_droplet" || echo "Ninguno"
            echo ""
            echo "ðŸ” Para limpiar droplets existentes, ejecuta:"
            echo "  cd terraform/digitalocean"
            echo "  terraform destroy"
            exit $EXIT_CODE
          }
      
      - name: Get Droplet IPs
        if: steps.check-secrets.outputs.skip != 'true'
        id: terraform-output
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        continue-on-error: true
        run: |
          # Obtener IPs de los 3 droplets (puede fallar si algunos no se crearon)
          APP_IP=$(terraform output -raw app_prod_ip 2>/dev/null || echo "")
          DATA_IP=$(terraform output -raw data_prod_ip 2>/dev/null || echo "")
          MONITORING_IP=$(terraform output -raw monitoring_prod_ip 2>/dev/null || echo "")
          
          # Guardar en outputs para otros jobs (usando app_ip para backend y frontend)
          echo "app_ip=$APP_IP" >> $GITHUB_OUTPUT
          echo "data_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "monitoring_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          # Mantener compatibilidad con nombres antiguos
          echo "backend_ip=$APP_IP" >> $GITHUB_OUTPUT
          echo "frontend_ip=$APP_IP" >> $GITHUB_OUTPUT
          echo "metabase_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "spark_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "temporal_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "grafana_prod_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          echo "grafana_staging_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          
          # Guardar en un archivo para que otros workflows puedan leerlo
          mkdir -p ${{ github.workspace }}/.github
          cat > ${{ github.workspace }}/.github/droplet-ips.json << EOF
          {
            "app": "$APP_IP",
            "data": "$DATA_IP",
            "monitoring": "$MONITORING_IP",
            "backend": "$APP_IP",
            "frontend": "$APP_IP",
            "metabase": "$DATA_IP",
            "spark": "$DATA_IP",
            "temporal": "$DATA_IP",
            "grafana_prod": "$MONITORING_IP",
            "grafana_staging": "$MONITORING_IP"
          }
          EOF
          
          echo "âœ… Droplet IPs guardados (3 droplets: app, data, monitoring)"
      
      - name: Output IPs
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        run: |
          echo "## ðŸš€ Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Droplet IPs:" >> $GITHUB_STEP_SUMMARY
          terraform output -json | jq -r 'to_entries[] | "- **\(.key)**: \(.value.value)"' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Wait for droplets to be ready (~2-3 minutes)" >> $GITHUB_STEP_SUMMARY
          echo "2. Backend and Frontend CD workflows will deploy automatically" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Droplet IPs
        if: steps.check-secrets.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: droplet-ips
          path: .github/droplet-ips.json
          retention-days: 30
      
      - name: Set Outputs for Other Workflows
        if: steps.check-secrets.outputs.skip != 'true'
        working-directory: ./terraform/digitalocean
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_ssh_key_id: ${{ steps.check-secrets.outputs.ssh_key_id }}
        run: |
          # Guardar IPs como outputs del job para que otros workflows puedan usarlas
          APP_IP=$(terraform output -raw app_prod_ip)
          DATA_IP=$(terraform output -raw data_prod_ip)
          MONITORING_IP=$(terraform output -raw monitoring_prod_ip)
          echo "app_ip=$APP_IP" >> $GITHUB_OUTPUT
          echo "data_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "monitoring_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          # Mantener compatibilidad con nombres antiguos
          echo "backend_ip=$APP_IP" >> $GITHUB_OUTPUT
          echo "frontend_ip=$APP_IP" >> $GITHUB_OUTPUT
          echo "metabase_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "spark_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "temporal_ip=$DATA_IP" >> $GITHUB_OUTPUT
          echo "grafana_prod_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
          echo "grafana_staging_ip=$MONITORING_IP" >> $GITHUB_OUTPUT
